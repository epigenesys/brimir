<div class="container-fluid">
  <div class="content mb-2 py-2 px-3">
    <%= form_tag tickets_path, method: :get, class: 'prm' do %>
      <%= hidden_field_tag(:assignee_id, params[:assignee_id]) unless params[:assignee_id].blank? %>
      <%= hidden_field_tag :status, params[:status] %>
      <div class="row">
        <div class="col-md-7 d-flex align-items-center">
          <% if params[:q].present? %>
            <h3 class="mb-0"><%= t(:count_tickets_containing, count: @tickets.count, status: params[:status]) %> '<em><%= params[:q].to_s %></em>'</h3>
          <% else %>
            <h3 class="mb-0"><%= t(:count_tickets, count: @tickets.count, status: params[:status]) %></h3>
          <% end %>
        </div>
        <div class="col-md-5 d-flex align-items-center">
          <% params.delete(:controller) %>
          <% params.delete(:action) %>

          <% if params[:status] == 'deleted' %>
            <%= link_to tickets_deleted_path, data: { remote: true, method: :delete, confirm: t(:are_you_sure_empty_trash) }, class: 'btn btn-danger mr-2' do %>
              <i class="fa fa-bomb"></i>
            <% end %>
          <% end %>

          <div class="input-group">
            <%= text_field_tag :q, params[:q], class: 'm-0 form-control', placeholder: "Search", 'aria-label' => "Search", 'aria-describedby' => "cloud-download-addon" %>
            <div class="input-group-append">
              <%= button_tag '<i class="fa fa-fw fa-search"></i>'.html_safe, type: 'submit', class: 'btn btn-outline-primary' %>
            </div>
          </div>
          <%= link_to tickets_path(:csv, permitted_params), class: 'btn btn-primary ml-2' do %>
            <i class="fa fa-cloud-download-alt" style="top:1px"></i>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="content tickets">
    <table class="table">
      <thead>
        <tr>
          <th>
            <div class="custom-control custom-checkbox single-checkbox">
              <input type="checkbox" class="custom-control-input" id="check-all-checkbox" data-toggle-all>
              <label class="custom-control-label" for="check-all-checkbox"></label>
            </div>
          </th>
          <th scope="col" colspan="2" class="py-0">
            <ul class="list-inline mb-0">
              <% { close: :closed, delete: :deleted, wait: :waiting }.each do |label, status| %>
                <li class="list-inline-item m-0">
                  <button type="submit" name="ticket[status]" value="<%= status %>" class="m-0 btn btn-text">
                    <%= t(label) %>
                  </button>
                </li>
              <% end %>
                <li class="list-inline-item m-0">
                  <button type="submit" name="merge" value="true" class="m-0 btn btn-text" title="<%=t :merge_explanation %>">
                    <%= t :merge %>
                  </button>
                </li>
            </ul>
          </th>
          <th scope="col">Replies</th>
          <th scope="col">Priority</th>
          <th scope="col">Labels</th>
          <th scope="col">
            <div class="dropdown">
              <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="select-order-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Select ticket order">
                <%= t("order.#{params[:order].present? ? params[:order] : :default}") %>
              </button>
              <div class="dropdown-menu" aria-labelledby="select-order-dropdown">
                <a class="dropdown-item" href="<%= root_path(params.to_unsafe_h.merge(order: nil)) %>">Latest updated (default)</a>
                <a class="dropdown-item" href="<%= root_path(params.to_unsafe_h.merge(order: :created_at)) %>">Newest first</a>
                <a class="dropdown-item" href="<%= root_path(params.to_unsafe_h.merge(order: 'created_at DESC')) %>">Oldest first</a>
                <a class="dropdown-item" href="<%= root_path(params.to_unsafe_h.merge(order: :priority)) %>">Priority order</a>
              </div>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <% @tickets.each do |ticket| %>
          <tr id="ticket_<%= ticket.id%>" class="ticket">
            <td>
              <div class="custom-control custom-checkbox single-checkbox">
                <input type="checkbox" value="<%= ticket.id %>" name="id[]" id="ticket_<%= ticket.id %>_checkbox" class="custom-control-input" data-toggle-check />
                <label class="custom-control-label" for="ticket_<%= ticket.id %>_checkbox"></label>
              </div>
            </td>
            <td class="px-0"><%= user_avatar ticket.user, size: 30 %></td>
            <td>
              <% unless ticket.subject.blank? %>
                <a href="<%= ticket_url(ticket) %>" class="d-block">
                  <strong><%= ticket.subject %></strong>
                </a>
              <% else %>
                <%= link_to ticket do %>
                  <em><%= t(:no_subject) %></em>
                <% end %>
              <% end %>
              <span class="block">
                <%= t(:ticket_id_created_by_at, id: ticket.id, user: link_to(ticket.user.email, user_tickets_path(user_id: ticket.user)),
                    at: l(ticket.created_at.in_time_zone(current_user.time_zone), format: :short)).html_safe %>
                (<%= time_ago_as_phrase(ticket.created_at.in_time_zone(current_user.time_zone), format: :short) %>)
              </span>
              <% if ticket.locked?(current_user) %>
                <em><%= t(:locked_by_user, user: ticket.locked_by.email) %></em>
              <% end %>
            </td>
            <td>
              <div class="badge badge-info">
                <%= fa_icon 'comments', text: ticket.replies.count %>
              </div>
            </td>
            <td><span class="badge badge-primary priority priority-<%= ticket.priority %>"><%= ticket.priority.capitalize %></span></td>
            <td>
              <% ticket.labels.viewable_by(current_user).each do |label| %>
                <%= render label %>
              <% end %>
            </td>
            <td>
              <span class="d-block" title="<%= l ticket.updated_at.in_time_zone(current_user.time_zone), format: :long %>">
                <%= time_ago_as_phrase(ticket.updated_at.in_time_zone(current_user.time_zone)) %>
              </span>
              <% if can? :update, ticket %>
                <% if ticket.assignee %>
                  <a data-assignee-id="<%= ticket.assignee.id %>" href="#"><%= ticket.assignee.email %></a>
                <% else %>
                  <a data-assignee-id="" href="#" class="text-default"><em><%= t(:unassigned) %></em></a>
                <% end %>
              <% else %>
                <% if ticket.assignee %>
                  <%= ticket.assignee.email %>
                <% else %>
                  <em><%= t(:unassigned) %></em>
                <% end %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <div class="pb-2 px-3">
      <%= will_paginate @tickets %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    $(document).on('hide', function() {
      $(document).on('show', function() {
        location.reload(true);
      });
    });
  });
</script>
